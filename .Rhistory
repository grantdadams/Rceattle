ymin[sp] <- min(c(quantity_upper95[sp, , ], 0), na.rm = T)
} else{
ymax[sp] <- max(c(quantity[sp, , ], 0), na.rm = T)
ymin[sp] <- min(c(quantity[sp, , ], 0), na.rm = T)
}
}
ymax <- ymax * 1.2
if (is.null(line_col)) {
if(!mse){
line_col <- rev(oce::oce.colorsViridis(length(Rceattle)))
}
if(mse){
line_col <- 1
}
}
# Plot trajectory
loops <- ifelse(is.null(file), 1, 2)
for (i in 1:loops) {
if (i == 2) {
filename <- paste0(file, "_b_eaten_as_prey_trajectory", ".png")
png(
file = filename ,
width = width,# 169 / 25.4,
height = height,# 150 / 25.4,
units = "in",
res = 300
)
}
# Plot configuration
layout(matrix(1:(length(spp) + 2), nrow = (length(spp) + 2)), heights = c(0.1, rep(1, length(spp)), 0.2))
par(
mar = c(0, 3 , 0 , 1) ,
oma = c(0 , 0 , 0 , 0),
tcl = -0.35,
mgp = c(1.75, 0.5, 0)
)
plot.new()
for (j in 1:length(spp)) {
plot(
y = NA,
x = NA,
ylim = c(ymin[spp[j]], ymax[spp[j]]),
xlim = c(minyr, maxyr + (maxyr - minyr) * right_adj),
xlab = "Year",
ylab = "Biomass consumed (million t)",
xaxt = c(rep("n", length(spp) - 1), "s")[j]
)
# Horizontal line at end yr
if(incl_proj){
abline(v = max_endyr, lwd  = lwd, col = "grey", lty = 2)
}
# Legends
legend("topleft",
legend = spnames[spp[j]],
bty = "n",
cex = 1)
if (spp[j] == 1) {
if(!is.null(model_names)){
legend(
"topright",
legend = model_names,
lty = rep(1, length(line_col)),
lwd = lwd,
col = line_col,
bty = "n",
cex = mod_cex
)
}
}
# Credible interval
if(estDynamics[spp[j]] == 0){
if (add_ci) {
for (k in 1:dim(quantity)[3]) {
# - 95% CI
polygon(
x = c(Years[[k]], rev(Years[[k]])),
y = c(quantity_upper95[spp[j], 1:length(Years[[k]]), k], rev(quantity_lower95[spp[j], 1:length(Years[[k]]), k])),
col = adjustcolor( line_col[k], alpha.f = alpha/2),
border = NA
)
# - 50% CI
if(mse){
polygon(
x = c(Years[[k]], rev(Years[[k]])),
y = c(quantity_upper50[spp[j], 1:length(Years[[k]]), k], rev(quantity_lower50[spp[j], 1:length(Years[[k]]), k])),
col = adjustcolor( line_col[k], alpha.f = alpha),
border = NA
)
}
}
}
}
# Mean quantity
for (k in 1:dim(quantity)[3]) {
lines(
x = Years[[k]],
y = quantity[spp[j], 1:length(Years[[k]]), k],
lty = 1,
lwd = lwd,
col = line_col[k]
) # Median
}
}
if (i == 2) {
dev.off()
}
}
}
# Plot mortality and predation
plot_b_eaten(Rceattle = mod_list, model_names = mod_names) # Biomass eaten as prey
library(Rceattle)
library(Rceattle)
install.packages(c('dplyr', 'ggplot2', 'oce', 'readxl', 'TMB', 'writexl', 'reshape2', 'gplots', 'tidyr', 'testthat'))
devtools::install_github("kaskr/TMB_contrib_R/TMBhelper") # install tmb helper
install.packages("devtools")
devtools::install_github("kaskr/TMB_contrib_R/TMBhelper") # install tmb helper
library(Rceattle)
library(Rceattle)
library(Rceattle)
library(Rceattle)
library(Rceattle)
library(Rceattle)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# -- NPFMC Tier 3
ss_run_Tier3 <- Rceattle::fit_mod(data_list = BS2017SS,
inits = ss_run$estimated_params,
estimateMode = 0, # Run projection only
HCR = build_hcr(HCR = 5, # Tier3 HCR
FsprTarget = 0.4, # F40%
FsprLimit = 0.35, # F35%
Plimit = 0.2, # No fishing when SB<SB20
Alpha = 0.2),
msmMode = 0, # Single species mode
verbose = 1)
library(Rceattle)
library(tidyr)
source("R/BSAI_condition_models.R")
ln_R <- 8
rec_dev <- rnorm(20)
R <- exp(ln_R + rec_dev)
meanR <- mean(R[1:10])
R - meanR
log(R - meanR)
log(R) - log(meanR)
exp(log(meanR) + log(R) - log(meanR))
R
library(Rceattle)
library(Rceattle)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# Estimate single-species and estimate M
BS2017SS_M <- BS2017SS
BS2017SS_M$est_M1 <- c(1,1,1)
ss_run_M <- Rceattle::fit_mod(data_list = BS2017SS_M,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# For the a multispecies model starting from the single species parameters, the following can be specified to load the data:
data("BS2017MS") # Note: the only difference is the residual mortality (M1_base) is lower
BS2017MS$est_M1 <- c(0,0,0) # Estimate residual M
BS2017MS$projyr <- 2060
ms_run <- Rceattle::fit_mod(data_list = BS2017MS,
inits = ss_run$estimated_params, # Initial parameters from single species ests
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
niter = 3, # 10 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
BS2017MS$fleet_control$proj_F_prop <- rep(1, 7)
ms_run_f25 <- Rceattle::fit_mod(data_list = BS2017MS,
inits = ms_run$estimated_params, # Initial parameters from single species ests
file = NULL, # Don't save
estimateMode = 2, # Estimate projection only
niter = 3, # 10 iterations around population and predation dynamics
HCR = build_hcr(HCR = 3, # Constant F HCR
DynamicHCR = FALSE, # Use dynamic reference points
FsprTarget = 0.25),
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
plot_ssb(list(ms_run, ms_run_f25), model_names = c("No F", "F25"), incl_proj = TRUE)
plot_catch(list(ms_run, ms_run_f25), incl_proj = TRUE)
library(Rceattle)
library(Rceattle)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# Estimate single-species and estimate M
BS2017SS_M <- BS2017SS
BS2017SS_M$est_M1 <- c(1,1,1)
ss_run_M <- Rceattle::fit_mod(data_list = BS2017SS_M,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# For the a multispecies model starting from the single species parameters, the following can be specified to load the data:
data("BS2017MS") # Note: the only difference is the residual mortality (M1_base) is lower
BS2017MS$est_M1 <- c(0,0,0) # Estimate residual M
BS2017MS$projyr <- 2060
ms_run <- Rceattle::fit_mod(data_list = BS2017MS,
inits = ss_run$estimated_params, # Initial parameters from single species ests
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
niter = 3, # 10 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
BS2017MS$fleet_control$proj_F_prop <- rep(1, 7)
ms_run_f25 <- Rceattle::fit_mod(data_list = BS2017MS,
inits = ms_run$estimated_params, # Initial parameters from single species ests
file = NULL, # Don't save
estimateMode = 2, # Estimate projection only
niter = 3, # 10 iterations around population and predation dynamics
HCR = build_hcr(HCR = 3, # Constant F HCR
DynamicHCR = FALSE, # Use dynamic reference points
FsprTarget = 0.25),
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
plot_ssb(list(ms_run, ms_run_f25), model_names = c("No F", "F25"), incl_proj = TRUE)
plot_catch(list(ms_run, ms_run_f25), incl_proj = TRUE)
#' Not in function
#'
#' @param x
#' @param y
#'
#' @export
#'
'%!in%' <- function(x,y){!('%in%'(x,y))}
plot_ssb(list(ms_run, ms_run_f25), model_names = c("No F", "F25"), incl_proj = TRUE)
plot_catch(list(ms_run, ms_run_f25), incl_proj = TRUE)
library(dplyr)
usethis::use_package("dplyr")
plot_catch(list(ms_run, ms_run_f25), incl_proj = TRUE)
plot_biomass(list(ss_run, ss_run_Tier3, ms_run, ms_run_f25), model_names = c("No F", "F25", "M No F", "M F25"), incl_proj = TRUE)
plot_depletion(ss_run, incl_proj = TRUE)
devtools::document()
library(Rceattle)
library(Rceattle)
library(Rceattle)
library(Rceattle)
devtools::document
devtools::document()
library(Rceattle)
library(Rceattle)
library(Rceattle)
?mse_run
devtools::document()
library(Rceattle)
?mse_run
devtools::document()
devtools::document()
devtools::document()
library(Rceattle)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
ss_run$quantities$flt_accum_age_upper
ss_run$quantities$joint_adjust
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
ss_run$quantities$flt_accum_age_upper
ss_run$quantities$check_lower_age
round(ss_run$quantities$check_lower_age)
round(ss_run$quantities$check_upper_age)
round(ss_run$quantities$joint_adjust)
round(ss_run$quantities$flt_accum_age_upper)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
round(ss_run$quantities$comp_obs,3)
(ss_run$quantities$check_upper_age)
(ss_run$quantities$joint_adjust)
(ss_run$quantities$flt_accum_age_upper)
(ss_run$quantities$check_sp)
(ss_run$quantities$check_flt)
(ss_run$quantities$check_age_test)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
(ss_run$quantities$check_n_comp)
(ss_run$quantities$check_upper_age)
(ss_run$quantities$joint_adjust)
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
################################################
# Estimation
################################################
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
round(ss_run$quantities$comp_hat,3)
