srr_pred_fun = 3,
proj_mean_rec = FALSE,
srr_est_mode = 1,
srr_prior_mean = alpha,
srr_prior_sd = 0.2,
Bmsy_lim = c(8000000, 400000, 500000)),
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1,
initMode = 2)
################################################
# Estimate OMs ----
################################################
# - Single-species fixed M
ss_run_ricker <- Rceattle::fit_mod(
data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 4, # Estimate hindcast only
M1Fun = build_M1(M1_model = 0,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
recFun = build_srr(srr_fun = 0,
srr_pred_fun = 3,
proj_mean_rec = FALSE,
srr_est_mode = 1,
srr_prior_mean = alpha,
srr_prior_sd = 0.2),
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1,
initMode = 2)
ss_run_ricker$data_list$Bmsy_lim
remove.packages("Rceattle")
library(Rceattle)
library(Rceattle)
library(dplyr)
################################################
# Data ----
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2100
data("BS2017MS") # Note: the only difference is the residual mortality (M1_base) is lower
BS2017MS$projyr <- 2100
BS2017SS$fleet_control$proj_F_prop <-rep(1,7)
BS2017MS$fleet_control$proj_F_prop <- rep(1, 7)
alpha = exp(c(4.121, 2.119, 1.553))
if(!exists("fit_all")){fit_all = TRUE}
################################################
# Estimate OMs ----
################################################
# - Single-species fixed M
ss_run_ricker <- Rceattle::fit_mod(
data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 1, # Estimate hindcast only
M1Fun = build_M1(M1_model = 0,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
recFun = build_srr(srr_fun = 0,
srr_pred_fun = 3,
proj_mean_rec = FALSE,
srr_est_mode = 1,
srr_prior_mean = alpha,
srr_prior_sd = 0.2),
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1,
initMode = 2)
plot_biomass(list(ss_run_ricker, ss_run), incl_proj = TRUE)
remove.packages("Rceattle")
library(Rceattle)
remove.packages("Rceattle")
library(Rceattle)
remove.packages("Rceattle")
remove.packages("Rceattle")
remove.packages("Rceattle")
remove.packages("Rceattle")
library(Rceattle)
library(Rceattle)
# Grant Adams, Kirstin Holsman, Andre Punt - April 2019
# Code to run Bering Sea CEATTLE model in TMB
# Citation:
# Holsman, K. K., Ianelli, J., Aydin, K., Punt, A. E., and Moffitt, E. A. 2015. A comparison of fisheries biological reference points estimated from temperature-specific multi-species and single-species climate-enhanced stock assessment models. Deep-Sea Research Part II: Topical Studies in Oceanography, 134: 360â€“378.
library(Rceattle)
library(Rceattle)
# Grant Adams, Kirstin Holsman, Andre Punt - April 2019
# Code to run Bering Sea CEATTLE model in TMB
# Citation:
# Holsman, K. K., Ianelli, J., Aydin, K., Punt, A. E., and Moffitt, E. A. 2015. A comparison of fisheries biological reference points estimated from temperature-specific multi-species and single-species climate-enhanced stock assessment models. Deep-Sea Research Part II: Topical Studies in Oceanography, 134: 360â€“378.
library(Rceattle)
################################################
# Data
################################################
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data("BS2017SS") # Single-species data. ?BS2017SS for more information on the data
data("BS2017MS") # Multi-species data. Note: the only difference is the residual mortality (M1_base) is lower
# Write data to excel
Rceattle::write_data(data_list = BS2017SS, file = "BS2017SS.xlsx")
# Change the data how you want in excel
# Read the data back in
mydata <- Rceattle::read_data( file = "BS2017SS.xlsx")
################################################
# Estimation
################################################
# - Single-species
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
mydata$fleet_control$proj_F_prop <- c(rep(1,3), rep(0,4))
ss_run <- Rceattle::fit_mod(data_list = mydata,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# - Multi-species
# For the a multispecies model we from the single species parameters.
BS2017MS$fleet_control$proj_F_prop <- c(rep(1,3), rep(0,4))
ms_run <- Rceattle::fit_mod(data_list = BS2017MS,
inits = ss_run$estimated_params, # Initial parameters from single species ests
M1Fun = build_M1(M1_model = 0,
updateM1 = TRUE,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
file = NULL, # Don't save
estimateMode = 0, # Estimate
niter = 10, # 3 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
save(ss_run, file = "CEATTLE_v11_SS.Rdata")
save(ms_run, file = "CEATTLE_v11_MS.Rdata")
plot_biomass(list(ss_run, ms_run))
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_SS.Rdata")
data(BS2017SS) # ?BS2017SS for more information on the data
ss_run_new <- Rceattle::fit_mod(data_list = mydata,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
testthat::expect_equal(round(ss_run$quantities$biomassSSB[1,10],4), 164.4717)
testthat::expect_equal(round(ss_run_new$quantities$biomassSSB[1,10],4), 164.4717)
plot_biomass(ss_run_new)
plot_biomass(list(ss_run_new, ss_run))
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_rearranged_SS.Rdata")
plot_biomass(list(ss_run_new, ss_run))
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_SS.Rdata")
inits <- build_params(BS2017SS)
BS2017SS$data_list$srr_prior_mean < 9
BS2017SS$data_list$srr_prior_mean <- 9
inits <- build_params(BS2017SS)
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$srr_prior_mean <- 9
inits <- build_params(BS2017SS)
BS2017SS$initMode  <- 1
BS2017SS$srr_prior_mean <- 9
BS2017SS$initMode  <- 1
inits <- build_params(BS2017SS)
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_SS.Rdata")
ss_run$estimated_params
inits$ln_mn_rec
inits$rec_pars
ss_run_new$estimated_params$rec_pars
ss_run$estimated_params$init_dev
# - Update population dynamics parameters only
inits$init_dev <- ss_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ss_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ss_run$estimated_params$ln_mn_rec
inits$F_dev[,1:39] <- ss_run$estimated_params$F_dev
inits$ln_mean_F <- ss_run$estimated_params$ln_mean_F
inits$F_dev[,1:39] <- ss_run$estimated_params$F_dev[,1:39]
ss_run$estimated_params$F_dev
inits$F_dev
ss_run_new
ss_run_new$estimated_params$F_dev
inits$F_dev[1:3, 1:39] <- ss_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F <- ss_run$estimated_params$ln_mean_F
ss_run_new$estimated_params$ln_mean_F
# - Update population dynamics parameters only
inits$init_dev <- ss_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ss_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ss_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ss_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ss_run$estimated_params$ln_mean_F
ss_run_old <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 4, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
inits <- build_params(BS2017SS)
# - Update population dynamics parameters only
inits$init_dev <- ss_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ss_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ss_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ss_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ss_run$estimated_params$ln_mean_F
ss_run_old <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 4, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
plot_biomass(ss_run_old)
plot_biomass(list(ss_run_old, ss_run_new))
inits <- build_params(BS2017SS)
# - Update population dynamics parameters only
inits$init_dev <- ss_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ss_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ss_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ss_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ss_run$estimated_params$ln_mean_F
ss_run_old <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 4, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
ss_run_new <- Rceattle::fit_mod(data_list = mydata,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
plot_biomass(list(ss_run_new, ss_run_old))
ss_run_old <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 3, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
plot_biomass(list(ss_run_new, ss_run_old))
names(inits)
ss_run$estimated_params$fsh_sel_coff
inits$sel_coff
ss_run_new$estimated_params$sel_coff
ss_run_new$estimated_params$sel_coff[,,1]
ss_run_new$estimated_params$sel_coff[,1,]
inits$sel_coff[1:3,1,] <- ss_run$estimated_params$fsh_sel_coff
ss_run_old <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 3, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
plot_biomass(list(ss_run_new, ss_run_old))
Test passed ðŸ˜€
# Previous time series
ss_run_old <- ss_run_new
ss_run$quantities$biomass
ss_run_old$quantities$biomass
# Previous time series
ss_run_old <- ss_run_new
# Load old model
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_SS.Rdata")
# Load data and set up inits
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$srr_prior_mean <- 9
BS2017SS$initMode  <- 1
inits <- build_params(BS2017SS)
# - Update population dynamics from previous parameters
inits$init_dev <- ss_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ss_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ss_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ss_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ss_run$estimated_params$ln_mean_F
inits$sel_coff[1:3,1,] <- ss_run$estimated_params$fsh_sel_coff
ss_run_old_params <- Rceattle::fit_mod(data_list = mydata,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 3, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# - Estimate instead
ss_run_new <- Rceattle::fit_mod(data_list = mydata,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# Previous time series
ss_run_old <- ss_run_new
ss_run_old$quantities$biomass[,1:39] <- ss_run$quantities$biomass
ss_run_old$quantities$biomassSSB[,1:39] <- ss_run$quantities$biomassSSB
# Plot
plot_biomass(list(ss_run_new, ss_run_old_params, ss_run_old))
# Plot
plot_biomass(list(ss_run_old_params, ss_run_old))
# Plot
plot_biomass(list(ss_run_new, ss_run_old_params, ss_run_old))
# Load old model
load("~/GitHub/Rceattle/inst/extdata/CEATTLE_classic_MS.Rdata")
# Load data and set up inits
data("BS2017SS")
data("BS2017MS")
BS2017MS$srr_prior_mean <- 9
BS2017MS$initMode  <- 1
inits <- build_params(BS2017MS)
# - Update population dynamics from old parameters
inits$init_dev <- ms_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ms_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ms_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ms_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ms_run$estimated_params$ln_mean_F
inits$sel_coff[1:3,1,] <- ms_run$estimated_params$fsh_sel_coff
ms_run_old_params <- Rceattle::fit_mod(
data_list = BS2017MS,
inits = inits, # Initial parameters from old model
M1Fun = build_M1(M1_model = 0,
updateM1 = TRUE,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
file = NULL, # Don't save
estimateMode = 3, # Estimate
niter = 10, # 3 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
#  Fit models
ss_run_new <- Rceattle::fit_mod(
data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = "default",
verbose = 1)
# - Multi-species
ms_run_new <- Rceattle::fit_mod(
data_list = BS2017MS,
inits = ss_run_new$estimated_params, # Initial parameters from single species ests
M1Fun = build_M1(M1_model = 0,
updateM1 = TRUE,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
file = NULL, # Don't save
estimateMode = 0, # Estimate
niter = 10, # 3 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
# Previous time series
ms_run_old <- ss_run_new
ms_run_old$quantities$biomass[,1:39] <- ms_run$quantities$biomass
ms_run_old$quantities$biomassSSB[,1:39] <- ms_run$quantities$biomassSSB
# Plot
plot_biomass(list(ms_run_new, ms_run_old_params, ms_run_old))
plot_biomassSSB(list(ms_run_new, ms_run_old_params, ms_run_old))
plot_ssb(list(ms_run_new, ms_run_old_params, ms_run_old))
ms_run_old_params$estimated_params$ln_M1
ms_run_old_params$estimated_params$ln_M1[,1,]
exp(ms_run_old_params$estimated_params$ln_M1[,1,])
ms_run_old$quantities$M1[,1,]
ms_run$quantities$M1
BS2017MS$M1_base
BS2017MS$M1_base[,-c(1:2)] <- ms_run$quantities$M1 # + 0.0001 is in the old one
inits <- build_params(BS2017MS)
# - Update population dynamics from old parameters
inits$init_dev <- ms_run$estimated_params$init_dev
inits$rec_dev[,1:39] <- ms_run$estimated_params$rec_dev
inits$rec_pars[,1] <- ms_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39] <- ms_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3] <- ms_run$estimated_params$ln_mean_F
inits$sel_coff[1:3,1,] <- ms_run$estimated_params$fsh_sel_coff
ms_run_old_params <- Rceattle::fit_mod(
data_list = BS2017MS,
inits = inits, # Initial parameters from old model
M1Fun = build_M1(M1_model = 0,
updateM1 = TRUE,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
file = NULL, # Don't save
estimateMode = 3, # Estimate
niter = 10, # 3 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
# Plot
plot_biomass(list(ms_run_new, ms_run_old_params, ms_run_old))
plot_ssb(list(ms_run_new, ms_run_old_params, ms_run_old))
# Previous time series
ms_run_old <- ms_run_new
ms_run_old$quantities$biomass[,1:39] <- ms_run$quantities$biomass
ms_run_old$quantities$biomassSSB[,1:39] <- ms_run$quantities$biomassSSB
# Plot
plot_biomass(list(ms_run_new, ms_run_old_params, ms_run_old))
plot_ssb(list(ms_run_new, ms_run_old_params, ms_run_old))
# Plot
plot_biomass(list(ms_run_old_params, ms_run_old))
# Plot
plot_biomass(list(ms_run_new, ms_run_old_params, ms_run_old))
# Plot
plot_recruitment(list(ms_run_new, ms_run_old_params, ms_run_old))
# Plot
plot_recruitment(list(ms_run_old_params, ms_run_old))
ms_run$estimated_params$ln_mn_rec
inits$rec_pars[,1]
inits$ln_mean_F[1:3]
ms_run$estimated_params$init_dev
# Load data and set up inits
data("BS2017SS")
data("BS2017MS")
BS2017MS$srr_prior_mean <- 9
BS2017MS$initMode  <- 1
BS2017MS$M1_base[,-c(1:2)] <- ms_run$quantities$M1 # + 0.0001 is in the old one
inits <- build_params(BS2017MS)
inits$init_dev
ms_run$estimated_params$init_dev
inits$init_dev
ms_run_new$estimated_params$init_dev
# - Update population dynamics from old parameters
inits$init_dev[,1:20] <- ms_run$estimated_params$init_dev
ms_run$estimated_params$rec_dev
inits$rec_dev[,1:39]
inits$rec_dev[,1:39] <- ms_run$estimated_params$rec_dev
ms_run$estimated_params$ln_mn_rec
inits$rec_pars[,1]
inits$rec_pars[,1] <- ms_run$estimated_params$ln_mn_rec
inits$F_dev[1:3, 1:39]
ms_run$estimated_params$F_dev[,1:39]
inits$F_dev[1:3, 1:39] <- ms_run$estimated_params$F_dev[,1:39]
inits$ln_mean_F[1:3]
inits$ln_mean_F[1:3] <- ms_run$estimated_params$ln_mean_F
inits$sel_coff[1:3,1,] <- ms_run$estimated_params$fsh_sel_coff
ms_run_old_params <- Rceattle::fit_mod(
data_list = BS2017MS,
inits = inits, # Initial parameters from old model
M1Fun = build_M1(M1_model = 0,
updateM1 = TRUE,
M1_use_prior = FALSE,
M2_use_prior = FALSE),
file = NULL, # Don't save
estimateMode = 3, # Estimate
niter = 10, # 3 iterations around population and predation dynamics
random_rec = FALSE, # No random recruitment
msmMode = 1, # MSVPA based
suitMode = 0, # empirical suitability
verbose = 1)
# Previous time series
ms_run_old <- ms_run_new
ms_run_old$quantities$biomass[,1:39] <- ms_run$quantities$biomass
ms_run_old$quantities$biomassSSB[,1:39] <- ms_run$quantities$biomassSSB
# Plot
plot_recruitment(list(ms_run_old_params, ms_run_old))
ms_run_old$quantities$R[,1:39] <- ms_run$quantities$R[,1:39]
ms_run_old$quantities$biomass[,1:39] <- ms_run$quantities$biomass
ms_run_old$quantities$biomassSSB[,1:39] <- ms_run$quantities$biomassSSB
# Plot
plot_recruitment(list(ms_run_old_params, ms_run_old))
# Plot
plot_recruitment(list(ms_run_old_params, ms_run_old))
plot_biomass(list(ms_run_new, ms_run_old_params, ms_run_old))
plot_ssb(list(ms_run_new, ms_run_old_params, ms_run_old))
ms_run$quantities$stom_div_bio2
ms_run$quantities$UobsWtAge_hat
head(BS2017MS$UobsWtAge)
system.file("executables",package="Rceattle")
load("C:/Users/Grant Adams/Documents/CEATTLE Runs/CEATTLE_classic_SS.Rdata")
ss_run$quantities$stomKir
ss_run$quantities$stomKirWt
head(ss_run$data_list$UobsAge)
head(ss_run$data_list$UobsAge[1,1,,])
head(ss_run$data_list$UobsAgeWt[1,1,,])
library(Rceattle)
data("BS2017SS")
head(BS2017SS$UobsAge)
head(BS2017SS$UobsAgeWt)
load("C:/Users/Grant Adams/Documents/CEATTLE Runs/CEATTLE_classic_MS.Rdata")
ms_run_old <- ms_run
load("C:/Users/Grant Adams/Documents/CEATTLE Runs/CEATTLE_classic_rearranged_MS.Rdata")
plot_biomass
library(Rceattle)
plot_biomass(list(ms_run_old, ms_run))
load("C:/Users/Grant Adams/Documents/CEATTLE Runs/CEATTLE_v09_MS.Rdata")
plot_biomass(list(ms_run_old, ms_run))
ms_run_old$quantities$biomass
ms_run_new <-  ms_run_old
ms_run_new$quantities$biomass <- ms_run$quantities$biomass[,1:39]
ms_run_new$quantities$biomassSSB <- ms_run$quantities$biomassSSB[,1:39]
plot_biomass(list(ms_run_old, ms_run_new))
