inits = NULL, # Initial parameters = 0
estimateMode = 3, # Don't estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
# * Fix-parameters and check derived quantities ----
inits <- ss_fix$estimated_params # get paramter object from NULL model
names(wham_model)
names(wham_model$parList)
# - Rec
inits$rec_pars[1,1] <- wham_model$parList$mean_rec_pars
inits$rec_dev[1,1] <- wham_model$parList$log_N1_pars[1] -  wham_model$parList$mean_rec_pars
inits$rec_dev[1,2:nyrs] <- wham_model$parList$log_NAA[,1] -  wham_model$parList$mean_rec_pars
inits$init_dev[1,] <- wham_model$parList$log_N1_pars[1] -  wham_model$parList$mean_rec_pars # WHAM assumes rec-dev in year 1 is applied to year-1 to year - nages
# - F (random walk in WHAM)
inits$ln_F[2,1]  <- wham_model$parList$log_F1
for(y in 2:nyrs){
inits$ln_F[2,y] <- inits$ln_F[2,y-1] + wham_model$parList$F_devs[y-1,1]
}
inits$ln_Finit[1] <- -Inf
# - Selectivity
selpars <-  wham_model$env$data$selpars_lower + ( wham_model$env$data$selpars_upper -  wham_model$env$data$selpars_lower) / (1.0 + exp(-(wham_model$parList$logit_selpars)))
inits$ln_sel_slp[1,,1] <- rev(log(1/selpars[,24]))
inits$sel_inf[1,,1] <- rev(selpars[,23])
# - Q
inits$index_ln_q[1] <- log(wham_model$env$data$q_lower + (wham_model$env$data$q_upper - wham_model$env$data$q_lower) / (1 + exp(-wham_model$parList$logit_q)))
# - Growth
inits$ln_growth_pars[1,1,1:3] <- wham_model$parList$growth_a[c(1,3,2),1]
inits$growth_ln_sd[1,1,] <- wham_model$parList$SDgrowth_par
ss_inits <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
estimateMode = 3, # Do not estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 2,
verbose = 1)
# SSB
plot(x = ss_inits$quantities$ssb[,1:nyrs] * 2, y = wham_model$rep$SSB); abline(0,1)
round(ss_inits$quantities$ssb[,1:nyrs] * 2 - wham_model$rep$SSB, 5) # Plus group in WHAM has a bug
# Rec
plot(x = ss_inits$quantities$N_at_age[1,1,1,1:nyrs], y = wham_model$rep$NAA[,1]); abline(0,1)
round(ss_inits$quantities$N_at_age[1,1,,1] - t(wham_model$rep$NAA)[,1], 6)
# N-at-age
round(ss_inits$quantities$N_at_age[1,1,,1:nyrs] - t(wham_model$rep$NAA), 6)
# Selex matches
plot(ss_inits$quantities$sel_at_length[1,1,,1], y = wham_model$rep$selLL[[2]][1,], xlab = "Rceattle survey sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,1], y = wham_model$rep$selLL[[1]][1,], xlab = "Rceattle fishery sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,10], y = wham_model$rep$selLL[[1]][10,], xlab = "Rceattle fishery sel"); abline(0,1)
# F
plot(x = ss_inits$quantities$F_spp[1,1:nyrs], y = wham_model$rep$F[,1]); abline(0,1)
ss_inits$quantities$F_spp[1,1:nyrs] - wham_model$rep$F[,1]
# F-at-age (good enough)
check <- outer(wham_model$rep$F[,1], t(wham_model$rep$catch_phi_mat[,,1]) %*% wham_model$rep$selLL[[1]][11,])
round(wham_model$rep$FAA_tot - check[,,1], 10)
round(t(wham_model$rep$FAA_tot) - ss_inits$quantities$F_spp_at_age[1,1,,1:nyrs], 10)
# ZAA (good enough)
round(t(wham_model$rep$ZAA) - ss_inits$quantities$Z_at_age[1,1,,1:nyrs], 10)
# M
plot(x = ss_inits$quantities$M1_at_age[1,1,1,1:nyrs], y = wham_model$rep$MAA[,1]); abline(0,1)
# Laa
plot(y = wham_model$rep$LAA[1,], x = t(ss_inits$quantities$length_hat[1,1,,1])); abline(0,1)
# Phi matrix
t(wham_model$rep$ssb_phi_mat[,,1]) - ss_inits$quantities$growth_matrix[1,1,,,1]
sum(t(wham_model$rep$catch_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
sum(t(wham_model$rep$fix_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
# Waa
plot(y = wham_model$rep$pred_waa[1,1,], x = t(ss_inits$quantities$weight_hat[3,1,,1])); abline(0,1) # Survey/Jan1 weight
plot(y = wham_model$rep$pred_waa[2,1,], x = t(ss_inits$quantities$weight_hat[4,1,,1])); abline(0,1) # Fishery weight
# Catch
plot(ss_inits$quantities$catch_hat[1:nyrs], wham_model$rep$pred_catch[,1]); abline(0,1)
# Index
plot(ss_inits$quantities$index_hat, wham_model$rep$pred_indices[,1]); abline(0,1)
# - IAAL
yr = 10
plot(x = t(wham_model$rep$pred_IAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[1,1,,,yr]); abline(0, 1)
# - CAAL
yr = 10
plot(x = t(wham_model$rep$pred_CAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[2,1,,,yr]); abline(0, 1)
# - COMP
par(mfrow = c(1, 2))
yr = 10
plot(x = wham_model$rep$pred_index_pal[,1,], y = ss_inits$quantities$comp_hat[1:nyrs,], xlab = "WHAM index comp", ylab = "Rceattle (fixed) index comp"); abline(0, 1) # Index
plot(x = wham_model$rep$pred_catch_pal[,1,], y = ss_inits$quantities$comp_hat[(nyrs+1):(nyrs*2),]); abline(0, 1) # Fishery
# - Likelihood
ss_inits$quantities$jnll_comp
sum(wham_model$rep$nll_agg_catch)
sum(wham_model$rep$nll_catch_lcomp)
sum(wham_model$rep$nll_agg_indices)
sum(wham_model$rep$nll_index_lcomp) # Comps use LL model 1
sum(wham_model$rep$nll_index_caal)
nll_NAA # Uses lognormal bias correction
wham_model$rep$nll_NAA # Uses lognormal bias correction
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = TRUE, # No random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
initMode = 1,
verbose = 1)
# Rceattle -------------------------------------------------------------
library(Rceattle)
data("GOAcod")
simData <- GOAcod
# * Make input data ----
# * Data controls
simData$nspp <- 1
years = 1976:2020 # years
nyrs <- length(years)
simData$styr <- 1976
simData$endyr <- 2020
simData$projyr <- 2030
simData$nsex <- 1
simData$nages <- 10
simData$minage <- 1
lengths = seq(from = 2, to = 130, by = 2) # lengths
simData$nlengths <- length(lengths)
simData$pop_wt_index <- 1
simData$ssb_wt_index <- 1
simData$spawn_month <- 0
simData$alpha_wt_len <- 5.56e-06
simData$beta_wt_len <- 3.2
simData$pop_age_transition_index <- 1
simData$sigma_rec_prior <- 0.6
nages <- simData$nages
nlengths <- simData$nlengths
# * Fleet control
simData$fleet_control <- simData$fleet_control[c(1,3),] # BT and Trawl Fishery are both simple logistic
simData$fleet_control$Fleet_name <- c("Survey", "Fishery")
simData$fleet_control$Fleet_code <- 1:2
simData$fleet_control$Selectivity <- 6                  # Length-based logistic
simData$fleet_control$Selectivity_index <- 1:2
simData$fleet_control$Weight_index <- 1
simData$fleet_control$Weight1_Numbers2 <- 1
simData$fleet_control$Month <- c(0, 6)
simData$fleet_control$Bin_first_selected <- 1
simData$fleet_control$Estimate_q <- c(0, NA)
simData$fleet_control$Q_prior <- c(1, NA)
# * Index data
simData$index_data <- data.frame(Fleet_name = "Survey",
Fleet_code = 1,
Species = 1,
Year = years,
Month = index_df$fr_yr,
Selectivity_block = 1,
Q_block = 1,
Observation = index_df$index,
Log_sd = index_df$cv)
# * Catch data
simData$catch_data <- data.frame(Fleet_name = "Fishery",
Fleet_code = 2,
Species = 1,
Year = years,
Month = 0,
Selectivity_block = 1,
Catch = catch_df$catch,
Log_sd = catch_df$cv)
# * Comp data
# - Index length comp
tmp <- as.matrix(index_lcomp_df[,3:67])
colnames(tmp) <- paste0("Comp_",1:simData$nlengths)
index_comp <- cbind(data.frame(Fleet_name = "Survey",
Fleet_code = 1,
Species = 1,
Sex = 0,
Age0_Length1 = 1,
Year = years, # Negative turns data off
Month = 0,
Sample_size = index_lcomp_df$Nsamp),
tmp
)
# - Fishery length comp
tmp <- as.matrix(fsh_lcomp_df[,3:67])
colnames(tmp) <- paste0("Comp_",1:simData$nlengths)
fishery_comp <- cbind(data.frame(Fleet_name = "Fishery",
Fleet_code = 2,
Species = 1,
Sex = 0,
Age0_Length1 = 1,
Year = years, # Negative turns data off
Month = 0,
Sample_size = fsh_lcomp_df$Nsamp),
tmp
)
simData$comp_data <- rbind(index_comp, fishery_comp)
# * CAAL data
# - Index
index_caal <- caal_df
colnames(index_caal) <- c("Year", "Length", "Sample_size", paste0("CAAL_",1:simData$nages))
simData$caal_data <- index_caal %>%
dplyr::mutate(Fleet_name = "Survey",
Fleet_code = 1,
Species = 1,
Sex = 0,
Species = 1) %>%
as.data.frame()
# - No fishery CAAL
# * Empirical selectivity
simData$emp_sel[] <- NA
# * Fixed numbers
simData$NByageFixed[] <- NA
# * Age transition matrix
tmp <- as.data.frame(diag(1,simData$nlengths))[1:simData$nages,]
colnames(tmp) <- paste0("Length_",1:simData$nlengths)
simData$age_trans_matrix <- cbind(data.frame(Age_transition_name = "Base",
Age_transition_index = 1,
Species = 1,
Sex = 0,
Age = 1:simData$nages),
tmp
)
# * Age error
tmp <- as.data.frame(diag(1,simData$nages))
colnames(tmp) <- paste0("Obs_age",1:simData$nages)
simData$age_error <- cbind(data.frame(Species = 1,
True_age = 1:simData$nages),
tmp
)
# * Empirical weight-at-age
WAA <- as.data.frame(matrix(1:simData$nages, ncol = simData$nages))
colnames(WAA) <- paste0("Age",1:simData$nages)
simData$weight <- cbind(data.frame(Wt_name = "Base",
Wt_index = 1,
Species = 1,
Sex = 0,
Year = 0), # 0 fills all years
WAA
)
# * Maturity (time-invariant in Rceattle)
MatAA <- matrix(maturity_df[1,2:11], ncol = simData$nages)
colnames(MatAA) <- paste0("Age",1:simData$nages)
simData$maturity <- cbind(data.frame(Species = 1),
MatAA
) %>%
as.data.frame()
# * Sex ratio
sexratio <- as.data.frame(matrix(0.5, ncol = simData$nages))
colnames(sexratio) <- paste0("Age",1:simData$nages)
simData$sex_ratio <- cbind(data.frame(Species = 1),
sexratio
)
# * Input mortality-at-age
mort <- as.data.frame(matrix(0.35, ncol = simData$nages))
colnames(mort) <- paste0("Age",1:simData$nages)
simData$M1_base <- cbind(data.frame(Species = 1,
Sex = 0),
mort
)
# * Environmental data
simData$env_data <- data.frame(Year = years,
EnvData = 1)
# * Ration data
pyrs <- as.data.frame(matrix(1, nrow = 1, ncol = simData$nages))
colnames(pyrs) <- paste0("Age",1:simData$nages)
simData$ration_data <- cbind(data.frame(Species = 1,
Sex = 0,
Year = 0), # Zero fills out all years
pyrs
)
# * Null Rceattle ----
ss_fix <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 3, # Don't estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
# * Fix-parameters and check derived quantities ----
inits <- ss_fix$estimated_params # get paramter object from NULL model
names(wham_model)
names(wham_model$parList)
# - Rec
inits$rec_pars[1,1] <- wham_model$parList$mean_rec_pars
inits$rec_dev[1,1] <- wham_model$parList$log_N1_pars[1] -  wham_model$parList$mean_rec_pars
inits$rec_dev[1,2:nyrs] <- wham_model$parList$log_NAA[,1] -  wham_model$parList$mean_rec_pars
inits$init_dev[1,] <- wham_model$parList$log_N1_pars[1] -  wham_model$parList$mean_rec_pars # WHAM assumes rec-dev in year 1 is applied to year-1 to year - nages
# - F (random walk in WHAM)
inits$ln_F[2,1]  <- wham_model$parList$log_F1
for(y in 2:nyrs){
inits$ln_F[2,y] <- inits$ln_F[2,y-1] + wham_model$parList$F_devs[y-1,1]
}
inits$ln_Finit[1] <- -Inf
# - Selectivity
selpars <-  wham_model$env$data$selpars_lower + ( wham_model$env$data$selpars_upper -  wham_model$env$data$selpars_lower) / (1.0 + exp(-(wham_model$parList$logit_selpars)))
inits$ln_sel_slp[1,,1] <- rev(log(1/selpars[,24]))
inits$sel_inf[1,,1] <- rev(selpars[,23])
# - Q
inits$index_ln_q[1] <- log(wham_model$env$data$q_lower + (wham_model$env$data$q_upper - wham_model$env$data$q_lower) / (1 + exp(-wham_model$parList$logit_q)))
# - Growth
inits$ln_growth_pars[1,1,1:3] <- wham_model$parList$growth_a[c(1,3,2),1]
inits$growth_ln_sd[1,1,] <- wham_model$parList$SDgrowth_par
ss_inits <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
estimateMode = 3, # Do not estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 2,
verbose = 1)
# SSB
plot(x = ss_inits$quantities$ssb[,1:nyrs] * 2, y = wham_model$rep$SSB); abline(0,1)
round(ss_inits$quantities$ssb[,1:nyrs] * 2 - wham_model$rep$SSB, 5) # Plus group in WHAM has a bug
# Rec
plot(x = ss_inits$quantities$N_at_age[1,1,1,1:nyrs], y = wham_model$rep$NAA[,1]); abline(0,1)
round(ss_inits$quantities$N_at_age[1,1,,1] - t(wham_model$rep$NAA)[,1], 6)
# N-at-age
round(ss_inits$quantities$N_at_age[1,1,,1:nyrs] - t(wham_model$rep$NAA), 6)
# Selex matches
plot(ss_inits$quantities$sel_at_length[1,1,,1], y = wham_model$rep$selLL[[2]][1,], xlab = "Rceattle survey sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,1], y = wham_model$rep$selLL[[1]][1,], xlab = "Rceattle fishery sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,10], y = wham_model$rep$selLL[[1]][10,], xlab = "Rceattle fishery sel"); abline(0,1)
# F
plot(x = ss_inits$quantities$F_spp[1,1:nyrs], y = wham_model$rep$F[,1]); abline(0,1)
ss_inits$quantities$F_spp[1,1:nyrs] - wham_model$rep$F[,1]
# F-at-age (good enough)
check <- outer(wham_model$rep$F[,1], t(wham_model$rep$catch_phi_mat[,,1]) %*% wham_model$rep$selLL[[1]][11,])
round(wham_model$rep$FAA_tot - check[,,1], 10)
round(t(wham_model$rep$FAA_tot) - ss_inits$quantities$F_spp_at_age[1,1,,1:nyrs], 10)
# ZAA (good enough)
round(t(wham_model$rep$ZAA) - ss_inits$quantities$Z_at_age[1,1,,1:nyrs], 10)
# M
plot(x = ss_inits$quantities$M1_at_age[1,1,1,1:nyrs], y = wham_model$rep$MAA[,1]); abline(0,1)
# Laa
plot(y = wham_model$rep$LAA[1,], x = t(ss_inits$quantities$length_hat[1,1,,1])); abline(0,1)
# Phi matrix
t(wham_model$rep$ssb_phi_mat[,,1]) - ss_inits$quantities$growth_matrix[1,1,,,1]
sum(t(wham_model$rep$catch_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
sum(t(wham_model$rep$fix_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
# Waa
plot(y = wham_model$rep$pred_waa[1,1,], x = t(ss_inits$quantities$weight_hat[3,1,,1])); abline(0,1) # Survey/Jan1 weight
plot(y = wham_model$rep$pred_waa[2,1,], x = t(ss_inits$quantities$weight_hat[4,1,,1])); abline(0,1) # Fishery weight
# Catch
plot(ss_inits$quantities$catch_hat[1:nyrs], wham_model$rep$pred_catch[,1]); abline(0,1)
# Index
plot(ss_inits$quantities$index_hat, wham_model$rep$pred_indices[,1]); abline(0,1)
# - IAAL
yr = 10
plot(x = t(wham_model$rep$pred_IAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[1,1,,,yr]); abline(0, 1)
# - CAAL
yr = 10
plot(x = t(wham_model$rep$pred_CAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[2,1,,,yr]); abline(0, 1)
# - COMP
par(mfrow = c(1, 2))
yr = 10
plot(x = wham_model$rep$pred_index_pal[,1,], y = ss_inits$quantities$comp_hat[1:nyrs,], xlab = "WHAM index comp", ylab = "Rceattle (fixed) index comp"); abline(0, 1) # Index
plot(x = wham_model$rep$pred_catch_pal[,1,], y = ss_inits$quantities$comp_hat[(nyrs+1):(nyrs*2),]); abline(0, 1) # Fishery
# - Likelihood
ss_inits$quantities$jnll_comp
sum(wham_model$rep$nll_agg_catch)
sum(wham_model$rep$nll_catch_lcomp)
sum(wham_model$rep$nll_agg_indices)
sum(wham_model$rep$nll_index_lcomp) # Comps use LL model 1
sum(wham_model$rep$nll_index_caal)
wham_model$rep$nll_NAA # Uses lognormal bias correction
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = TRUE, # No random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
initMode = 1,
verbose = 1)
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
initMode = 1,
verbose = 1)
ss_est
wham_ests <- ss_est
wham_ests$quantities$ssb[1,1:nyrs] <- wham_model$rep$SSB/2
plot_ssb(list(ss_est, ss_inits, wham_ests), model_names = c("Rceattle", "Rceattle - fixed", "WHAM"))
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
initMode = 1,
verbose = 1)
ss_est
wham_ests <- ss_est
wham_ests$quantities$ssb[1,1:nyrs] <- wham_model$rep$SSB/2
plot_ssb(list(ss_est, ss_inits, wham_ests), model_names = c("Rceattle", "Rceattle - fixed", "WHAM"))
wham_ests <- ss_est
wham_ests$quantities$ssb[1,1:nyrs] <- wham_model$rep$SSB/2
plot_ssb(list(ss_est, ss_inits, wham_ests), model_names = c("Rceattle", "Rceattle - fixed", "WHAM"))
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 1,
verbose = 1)
# - Likelihood
ss_inits$quantities$jnll_comp
wham_model$rep$nll_NAA # Uses lognormal bias correction
ss_inits <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
estimateMode = 3, # Do not estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 1,
verbose = 1)
# SSB
plot(x = ss_inits$quantities$ssb[,1:nyrs] * 2, y = wham_model$rep$SSB); abline(0,1)
round(ss_inits$quantities$ssb[,1:nyrs] * 2 - wham_model$rep$SSB, 5) # Plus group in WHAM has a bug
# Rec
plot(x = ss_inits$quantities$N_at_age[1,1,1,1:nyrs], y = wham_model$rep$NAA[,1]); abline(0,1)
round(ss_inits$quantities$N_at_age[1,1,,1] - t(wham_model$rep$NAA)[,1], 6)
# N-at-age
round(ss_inits$quantities$N_at_age[1,1,,1:nyrs] - t(wham_model$rep$NAA), 6)
# Selex matches
plot(ss_inits$quantities$sel_at_length[1,1,,1], y = wham_model$rep$selLL[[2]][1,], xlab = "Rceattle survey sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,1], y = wham_model$rep$selLL[[1]][1,], xlab = "Rceattle fishery sel"); abline(0,1)
plot(ss_inits$quantities$sel_at_length[2,1,,10], y = wham_model$rep$selLL[[1]][10,], xlab = "Rceattle fishery sel"); abline(0,1)
# F
plot(x = ss_inits$quantities$F_spp[1,1:nyrs], y = wham_model$rep$F[,1]); abline(0,1)
ss_inits$quantities$F_spp[1,1:nyrs] - wham_model$rep$F[,1]
# F-at-age (good enough)
check <- outer(wham_model$rep$F[,1], t(wham_model$rep$catch_phi_mat[,,1]) %*% wham_model$rep$selLL[[1]][11,])
round(wham_model$rep$FAA_tot - check[,,1], 10)
round(t(wham_model$rep$FAA_tot) - ss_inits$quantities$F_spp_at_age[1,1,,1:nyrs], 10)
# ZAA (good enough)
round(t(wham_model$rep$ZAA) - ss_inits$quantities$Z_at_age[1,1,,1:nyrs], 10)
# M
plot(x = ss_inits$quantities$M1_at_age[1,1,1,1:nyrs], y = wham_model$rep$MAA[,1]); abline(0,1)
# Laa
plot(y = wham_model$rep$LAA[1,], x = t(ss_inits$quantities$length_hat[1,1,,1])); abline(0,1)
# Phi matrix
t(wham_model$rep$ssb_phi_mat[,,1]) - ss_inits$quantities$growth_matrix[1,1,,,1]
sum(t(wham_model$rep$catch_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
sum(t(wham_model$rep$fix_phi_mat[,,5]) - ss_inits$quantities$growth_matrix[4,1,,,5])
# Waa
plot(y = wham_model$rep$pred_waa[1,1,], x = t(ss_inits$quantities$weight_hat[3,1,,1])); abline(0,1) # Survey/Jan1 weight
plot(y = wham_model$rep$pred_waa[2,1,], x = t(ss_inits$quantities$weight_hat[4,1,,1])); abline(0,1) # Fishery weight
# Catch
plot(ss_inits$quantities$catch_hat[1:nyrs], wham_model$rep$pred_catch[,1]); abline(0,1)
# Index
plot(ss_inits$quantities$index_hat, wham_model$rep$pred_indices[,1]); abline(0,1)
# - IAAL
yr = 10
plot(x = t(wham_model$rep$pred_IAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[1,1,,,yr]); abline(0, 1)
# - CAAL
yr = 10
plot(x = t(wham_model$rep$pred_CAAL[yr,1,,]), y = ss_inits$quantities$pred_CAAL[2,1,,,yr]); abline(0, 1)
# - COMP
par(mfrow = c(1, 2))
yr = 10
plot(x = wham_model$rep$pred_index_pal[,1,], y = ss_inits$quantities$comp_hat[1:nyrs,], xlab = "WHAM index comp", ylab = "Rceattle (fixed) index comp"); abline(0, 1) # Index
plot(x = wham_model$rep$pred_catch_pal[,1,], y = ss_inits$quantities$comp_hat[(nyrs+1):(nyrs*2),]); abline(0, 1) # Fishery
# - Likelihood
ss_inits$quantities$jnll_comp
sum(wham_model$rep$nll_agg_catch)
sum(wham_model$rep$nll_catch_lcomp)
sum(wham_model$rep$nll_agg_indices)
sum(wham_model$rep$nll_index_lcomp) # Comps use LL model 1
sum(wham_model$rep$nll_index_caal)
wham_model$rep$nll_NAA # Uses lognormal bias correction
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 1,
verbose = 1)
wham_ests <- ss_est
wham_ests$quantities$ssb[1,1:nyrs] <- wham_model$rep$SSB/2
# Estimate Rceattle ----
#FIXME: Finit for initmode 3 and 4
ss_est <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
estimateMode = 0, # estimate
growthFun = build_growth(growth_model = 1), # Von Bert
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
initMode = 2,
verbose = 1)
wham_ests <- ss_est
wham_ests$quantities$ssb[1,1:nyrs] <- wham_model$rep$SSB/2
plot_ssb(list(ss_est, ss_inits, wham_ests), model_names = c("Rceattle", "Rceattle - fixed", "WHAM"))
