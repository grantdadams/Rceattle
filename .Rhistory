# F
sum(ms_run1$quantities$F_flt_age[c(2,4),1,,1:nyrs] - sim$FAA)
# Q
ms_run1$quantities$index_q
sim$srv_q
# * Full  diet -----
# Get all combinations of indices
idx <- which(!is.na(sim$diet_prop), arr.ind = TRUE)  # or sim$diet_prop != 0 for nonzero only
# Build the data frame directly
simData$diet_data <- data.frame(
Year = idx[, 5],
Pred = idx[, 1],
Prey = idx[, 2],
Pred_sex = 0,
Prey_sex = 0,
Pred_age = idx[, 3],
Prey_age = idx[, 4],
Sample_size = 100,
Stomach_proportion_by_weight = sim$diet_prop[idx]
)
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
ss_run$estimated_params$log_gam_a <- log(gam_a)
ss_run$estimated_params$log_gam_b <- log(gam_b)
ss_run$estimated_params$log_phi <- log_phi
ms_run1 <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
suitMode = 4,
niter = 5,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run1$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run1$quantities$biomass[2,1:nyrs]); abline(1,1)
exp(ms_run1$estimated_params$log_gam_a)
gam_a
exp(ms_run1$estimated_params$log_gam_b)
gam_b
ms_run1$quantities$vulnerability
sim$vulnerability
# * Average diet across years -----
simData$diet_data[] <- NA
ind = 1
for(i in 1:dim(sim$diet_prop)[1]){ # pred
for(j in 1:dim(sim$diet_prop)[2]){ # prey
for(k in 1:dim(sim$diet_prop)[3]){ # pred age
for(l in 1:dim(sim$diet_prop)[4]){ # prey-age
simData$diet_data[ind,] <- NA
simData$diet_data$Year[ind] <- 0 # average years
simData$diet_data$Pred[ind] <- i
simData$diet_data$Prey[ind] <- j
simData$diet_data$Pred_sex[ind] <- 0
simData$diet_data$Prey_sex[ind] <- 0
simData$diet_data$Pred_age[ind] <- k
simData$diet_data$Prey_age[ind] <- l
simData$diet_data$Sample_size[ind] <- 200
simData$diet_data$Stomach_proportion_by_weight[ind] <- mean(sim$diet_prop[i,j,k,l,])
ind = ind+1
}
}
}
}
simData$diet_data$Sample_size <- 1000
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
ms_run2 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run2$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run2$quantities$biomass[2,1:nyrs]); abline(1,1)
# * Annual prey-spp diet -----
simData$diet_data[] <- NA
ind = 1
for(i in 1:dim(sim$diet_prop)[1]){ # pred
for(j in 1:dim(sim$diet_prop)[2]){ # prey
for(k in 1:dim(sim$diet_prop)[3]){ # pred age
for(m in 1:dim(sim$diet_prop)[5]){ # year
simData$diet_data[ind,] <- NA
simData$diet_data$Year[ind] <- m
simData$diet_data$Pred[ind] <- i
simData$diet_data$Prey[ind] <- j
simData$diet_data$Pred_sex[ind] <- 0
simData$diet_data$Prey_sex[ind] <- 0
simData$diet_data$Pred_age[ind] <- k
simData$diet_data$Prey_age[ind] <- -500  # sum across prey-ages
simData$diet_data$Sample_size[ind] <- 200
simData$diet_data$Stomach_proportion_by_weight[ind] <- sum(sim$diet_prop[i,j,k,,m])
ind = ind+1
}
}
}
}
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
ms_run3 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run3$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run3$quantities$biomass[2,1:nyrs]); abline(1,1)
# * Average prey-spp diet across years -----
simData$diet_data[] <- NA
ind = 1
for(i in 1:dim(sim$diet_prop)[1]){ # pred
for(j in 1:dim(sim$diet_prop)[2]){ # prey
for(k in 1:dim(sim$diet_prop)[3]){ # pred age
simData$diet_data[ind,] <- NA
simData$diet_data$Year[ind] <- 0 # average of years
simData$diet_data$Pred[ind] <- i
simData$diet_data$Prey[ind] <- j
simData$diet_data$Pred_sex[ind] <- 0
simData$diet_data$Prey_sex[ind] <- 0
simData$diet_data$Pred_age[ind] <- k
simData$diet_data$Prey_age[ind] <- -500 # sum across prey-ages
simData$diet_data$Sample_size[ind] <- 200
simData$diet_data$Stomach_proportion_by_weight[ind] <- mean(rowSums(sim$diet_prop[i,j,k,,]))
ind = ind+1
}
}
}
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
ms_run4 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run4$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run4$quantities$biomass[2,1:nyrs]); abline(1,1)
plot(x = ms_run4$data_list$diet_data$Stomach_proportion_by_weight, y = ms_run4$quantities$diet_hat[,2], xlab = "True diet", ylab ="Est diet", main = "Average sum diet")
abline(1,1)
abline(1)
abline(1,1)
abline
abline(0,1)
plot(x = sim$Total_Biom[1,], y = ms_run4$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run4$quantities$biomass[2,1:nyrs]); abline(0,1)
plot(x = ms_run4$data_list$diet_data$Stomach_proportion_by_weight, y = ms_run4$quantities$diet_hat[,2], xlab = "True diet", ylab ="Est diet", main = "Average sum diet")
abline(0,1)
plot(x = sim$Total_Biom[1,], y = ms_run3$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run3$quantities$biomass[2,1:nyrs]); abline(0,1)
plot(x = ms_run3$data_list$diet_data$Stomach_proportion_by_weight, y = ms_run3$quantities$diet_hat[,2], xlab = "True diet", ylab ="Est diet", main = "Average sum diet")
abline(0,1)
profile()
?profile
library(Rceattle)
data("GOA2018SS")
diet_data <- GOA2018SS$diet_data
colnames(diet_data)
colnames(diet_data)
library(dplyr)
# Get distinct predator combinations
distinct_pred <- diet_data %>%
distinct(Pred, Pred_sex, Pred_age)
distinct_pred
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
# Setup ----
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
library(Rceattle)
library(dplyr)
library(ggplot2)
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
# Data ----
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
# Example
# To run the 2017 single species assessment for the Bering Sea, a data file must first be loaded:
data(BS2017SS) # ?BS2017SS for more information on the data
BS2017SS$projyr <- 2060
# Write data to excel
Rceattle::write_data(data_list = BS2017SS, file = "BS2017SS.xlsx")
# Change the data how you want in excel
# Read the data back in
mydata <- Rceattle::read_data( file = "BS2017SS.xlsx")
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
# Estimation ----
#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#-#
# Then the model can be fit by setting `msmMode = 0` using the `Rceattle` function:
ss_run <- Rceattle::fit_mod(data_list = BS2017SS,
file = NULL,
phase = TRUE, # Phase the model
inits = NULL, # Initial parameters = 0
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
verbose = 1)
data_list <- ss_run$data_list
# Data dimensions
max_sex <- max(data_list$nsex, na.rm = T)
max_age <- max(data_list$nages, na.rm = T)
max_length <- max(data_list$nlengths, na.rm = T)
yrs_hind <- data_list$styr:data_list$endyr
yrs_proj <- data_list$styr:data_list$projyr
nyrs_hind <- length(yrs_hind)
nyrs_proj <- length(yrs_proj)
# 1 - remove non-integer objects from control ----
data_list$index_ln_q_prior <- log(data_list$fleet_control$Q_prior)
data_list$fleet_control <- data_list$fleet_control %>%
dplyr::select(Fleet_name,
Fleet_code,           # 1) Temporary survey index
Fleet_type,           # 2) Fleet type; 0 = don't fit, 1 = fishery, 2 = survey
Species,              # 3) Species
Selectivity_index,    # 4) Survey selectivity index
Selectivity,          # 5) Selectivity type
Nselages,             # 6) Non-parametric selectivity ages
Time_varying_sel,     # 7) Time-varying selectivity type.
Age_first_selected,   # 8) First age selected
Age_max_selected,     # 9b) Age of max selectivity (used for normalization). If NA, does not normalize
Age_max_selected_upper,# 9a) upper age of max selectivity (used for normalization). If NA, does not normalize
Comp_loglike,         # 10) Index indicating wether to do dirichlet multinomial for a multinomial)
Weight1_Numbers2,     # 11) Survey units
Weight_index,         # 12) Dim1 of weight (what weight-at-age data set)
Age_transition_index, # 13) Dim3 of age transition matrix (what ALK to use)
Q_index,              # 14) Index of survey q
Estimate_q,           # 15) Parametric form of q
Time_varying_q,       # 16) Time varying q type
Estimate_index_sd,    # 17) Wether to estimate standard deviation of survey time series
Estimate_catch_sd     # 18) Wether to estimate standard deviation of fishery time series
)
data_list$fleet_control$Time_varying_sel <- round(data_list$fleet_control$Time_varying_sel)
data_list$fleet_control$Fleet_name <- suppressWarnings(as.numeric(as.character(data_list$fleet_control$Fleet_name)))
data_list$fleet_control$Time_varying_q <- suppressWarnings(as.numeric(as.character(data_list$fleet_control$Time_varying_q)))
# Species names
data_list$spnames <- NULL
# * F reference points ----
data_list$Ftarget_percent <- data_list$Ftarget
data_list$Flimit_percent <- data_list$Flimit
# - Input missing nselages and age first selected (use age range)
data_list$fleet_control <- data_list$fleet_control %>%
dplyr::mutate(Nselages = ifelse(is.na(Nselages), -999, Nselages),
Age_max_selected = ifelse(Age_max_selected < 0, -99, Age_max_selected),     # Less than zero, normalize by max
Age_max_selected = ifelse(is.na(Age_max_selected), -999, Age_max_selected), # NA, do not normalize (unless type = 2)
Age_max_selected_upper = ifelse(is.na(Age_max_selected_upper), -999, Age_max_selected_upper),
Age_first_selected = ifelse(is.na(Age_first_selected), data_list$minage[Species], Age_first_selected)
)
# 2 -  Seperate survey biomass info from observation ----
data_list$index_ctl <- data_list$index_data %>%
dplyr::select(Fleet_code, Species, Year) %>%
dplyr::mutate_all(as.integer)
data_list$index_n <- as.matrix(data_list$index_data[,c("Month")])
data_list$index_obs <- data_list$index_data %>%
dplyr::select(Observation, Log_sd) %>%
dplyr::mutate_all(as.numeric)
# 3 -  Seperate catch biomass info from observation ----
data_list$catch_ctl <- data_list$catch_data %>%
dplyr::select(Fleet_code, Species, Year) %>%
dplyr::mutate_all(as.integer)
data_list$catch_n <- as.matrix(data_list$catch_data[,c("Month")])
data_list$catch_obs <- data_list$catch_data %>%
dplyr::select(Catch, Log_sd) %>%
dplyr::mutate_all(as.numeric)
# 4 -  Seperate comp data from observation ----
data_list$comp_ctl <- data_list$comp_data %>%
dplyr::select(Fleet_code, Species, Sex, Age0_Length1, Year) %>%
dplyr::mutate_all(as.integer)
data_list$comp_n <- data_list$comp_data %>%
dplyr::select(Month, Sample_size) %>%
dplyr::mutate_all(as.numeric)
data_list$comp_obs <- data_list$comp_data %>%
dplyr::select(contains("Comp_")) %>%
dplyr::mutate_all(as.numeric)
data_list <- check_composition_data(data_list)
# 5 -  Seperate diet info from observation ----
data_list$diet_ctl <- data_list$diet_data %>%
dplyr::select(Pred, Prey, Pred_sex, Prey_sex, Pred_age, Prey_age, Year) %>%
dplyr::mutate_all(as.integer)
data_list$diet_obs <- data_list$diet_data %>%
dplyr::select(Sample_size, Stomach_proportion_by_weight) %>%
dplyr::mutate_all(as.numeric)
other_diet <- data_list$diet_data %>%
dplyr::group_by(Pred, Pred_sex, Pred_age, Year, Sample_size) %>%
dplyr::summarise(Other_food_proportion = 1 - sum(Stomach_proportion_by_weight, na.rm = TRUE))
other_diet
if(nrow(other_diet) < other_diet %>%
distinct(Pred, Pred_sex, Pred_age, Year) %>%
nrow()){
stop("Sample size for a distinct predator (Pred, Pred_sex, Pred_age, Year) differs for some observations in 'diet_data'")
}
data_list$other_food_ctl <- other_diet %>%
dplyr::select(Pred, Pred_sex, Pred_age, Year) %>%
dplyr::mutate_all(as.integer)
# - Other food
other_diet <- data_list$diet_data %>%
dplyr::group_by(Pred, Pred_sex, Pred_age, Year, Sample_size) %>%
dplyr::summarise(Other_food_proportion = 1 - sum(Stomach_proportion_by_weight, na.rm = TRUE)) %>%
dplyr::ungroup()
if(nrow(other_diet) < other_diet %>%
distinct(Pred, Pred_sex, Pred_age, Year) %>%
nrow()){
stop("Sample size for a distinct predator (Pred, Pred_sex, Pred_age, Year) differs for some observations in 'diet_data'")
}
data_list$other_food_ctl <- other_diet %>%
dplyr::select(Pred, Pred_sex, Pred_age, Year) %>%
dplyr::mutate_all(as.integer)
data_list$other_food_obs <- other_diet %>%
dplyr::select(Sample_size, Other_food_proportion) %>%
dplyr::mutate_all(as.numeric)
# Code to run DSEM-linked assessment models
# NOTE: we have to phase the models to get to a better starting point
library(Rceattle)
# Model 1 ----
# Single-species GOA pollock, IID recruitment
data("GOApollock") # Single-species data. ?BS2017SS for more information on the data
GOApollock$projyr <- 2020  # Shorten proj year for quicker estimation
GOApollock$env_data <- GOApollock$env_data %>%
dplyr::mutate(ScaledBT =scale(BTempC))
model1 <- Rceattle::fit_mod(data_list = GOApollock,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
remove.packages("Rceattle")
install.packages('dsem')
# Code to run DSEM-linked assessment models
# NOTE: we have to phase the models to get to a better starting point
library(Rceattle)
# Model 1 ----
# Single-species GOA pollock, IID recruitment
data("GOApollock") # Single-species data. ?BS2017SS for more information on the data
GOApollock$projyr <- 2020  # Shorten proj year for quicker estimation
GOApollock$env_data <- GOApollock$env_data %>%
dplyr::mutate(ScaledBT =scale(BTempC))
model1 <- Rceattle::fit_mod(data_list = GOApollock,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
model1$data_list$dsem_settings$sem
# Model 2 ----
# IID sem, if start value is not provided, DSEM terms will not be estimated
sem_iid = "
# link, lag, param_name, start_value
#internal data relation
ScaledBT -> ScaledBT, 1, AR_BT, 0
ScaledBT -> recdevs1, 1, BT_to_R, 0
recdevs1 <-> recdevs1, 0, sigmaR1, 1
"
model2 <- Rceattle::fit_mod(data_list = GOApollock,
inits = NULL, # Initial parameters from model 1
file = NULL, # Don't save
estimateMode = 0, # Estimate
dsem = build_DSEM(
sem = sem_iid,
family = "normal"
),
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
# * Plot ----
mod_list <- list(model1, model2)
mod_names <- c("Single-species IID", "Single-species Env")
plot_biomass(Rceattle = mod_list, model_names = mod_names)
plot_recruitment(Rceattle = mod_list, model_names = mod_names)
# Model 3 ----
# Three species IID model
data("BS2017SS") # Single-species data for EBS model
BS2017SS$projyr <- 2020  # Shorten proj year for quicker estimation
model3 <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
verbose = 1)
print(model3$data_list$dsem_settings$sem) # Default SEM
model3$estimated_params$beta_z # sigmaR
# Model 4 ----
# Three species IID model (cod and ATF recruitment impact pollock recruitment)
sem_3spp = "
# link, lag, param_name, start_value
recdevs1 <-> recdevs1, 0, sigmaR1, 1
recdevs2 <-> recdevs2, 0, sigmaR2, 1
recdevs3 <-> recdevs3, 0, sigmaR3, 1
recdevs2 -> recdevs1, 0, R2_to_R1, 0
recdevs3 -> recdevs1, 0, R3_to_R1, 0
"
model4 <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
dsem = build_DSEM(
sem = sem_3spp,
family = "normal"
),
msmMode = 0, # Single species mode
phase = TRUE,
verbose = 1)
# * Plot ----
mod_list <- list(model3, model4)
mod_names <- c("Three-species IID", "Three-species linked")
plot_biomass(Rceattle = mod_list, model_names = mod_names)
plot_recruitment(Rceattle = mod_list, model_names = mod_names)
mod_list <- list(model1, model2, model3, model4)
save(mod_list, file = "DSEM.Rdata")
# Code to run DSEM-linked assessment models
# NOTE: we have to phase the models to get to a better starting point
library(Rceattle)
# Model 1 ----
# Single-species GOA pollock, IID recruitment
data("GOApollock") # Single-species data. ?BS2017SS for more information on the data
GOApollock$projyr <- 2020  # Shorten proj year for quicker estimation
GOApollock$env_data <- GOApollock$env_data %>%
dplyr::mutate(ScaledBT =scale(BTempC))
model1 <- Rceattle::fit_mod(data_list = GOApollock,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
model1$data_list$dsem_settings$sem
# Model 2 ----
# IID sem, if start value is not provided, DSEM terms will not be estimated
sem_iid = "
# link, lag, param_name, start_value
#internal data relation
ScaledBT -> ScaledBT, 1, AR_BT, 0
ScaledBT -> recdevs1, 1, BT_to_R, 0
recdevs1 <-> recdevs1, 0, sigmaR1, 1
"
model2 <- Rceattle::fit_mod(data_list = GOApollock,
inits = NULL, # Initial parameters from model 1
file = NULL, # Don't save
estimateMode = 0, # Estimate
dsem = build_DSEM(
sem = sem_iid,
family = "normal"
),
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = FALSE,
verbose = 1)
# * Plot ----
mod_list <- list(model1, model2)
mod_names <- c("Single-species IID", "Single-species Env")
plot_biomass(Rceattle = mod_list, model_names = mod_names)
plot_recruitment(Rceattle = mod_list, model_names = mod_names)
# Model 3 ----
# Three species IID model
data("BS2017SS") # Single-species data for EBS model
BS2017SS$projyr <- 2020  # Shorten proj year for quicker estimation
model3 <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
verbose = 1)
print(model3$data_list$dsem_settings$sem) # Default SEM
model3$estimated_params$beta_z # sigmaR
# Model 4 ----
# Three species IID model (cod and ATF recruitment impact pollock recruitment)
sem_3spp = "
# link, lag, param_name, start_value
recdevs1 <-> recdevs1, 0, sigmaR1, 1
recdevs2 <-> recdevs2, 0, sigmaR2, 1
recdevs3 <-> recdevs3, 0, sigmaR3, 1
recdevs2 -> recdevs1, 0, R2_to_R1, 0
recdevs3 -> recdevs1, 0, R3_to_R1, 0
"
model4 <- Rceattle::fit_mod(data_list = BS2017SS,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = TRUE, # Random recruitment
dsem = build_DSEM(
sem = sem_3spp,
family = "normal"
),
msmMode = 0, # Single species mode
phase = TRUE,
verbose = 1)
# * Plot ----
mod_list <- list(model3, model4)
mod_names <- c("Three-species IID", "Three-species linked")
plot_biomass(Rceattle = mod_list, model_names = mod_names)
plot_recruitment(Rceattle = mod_list, model_names = mod_names)
