Wt_index = 1,
Species = 1,
Sex = 0,
Year = 0),
WAA
)
WAA2 <- as.data.frame(matrix(WAA2, ncol = 15))
colnames(WAA2) <- paste0("Age",1:15)
weight2 <- cbind(data.frame(Wt_name = "Base2",
Wt_index = 2,
Species = 2,
Sex = 0,
Year = 0),
WAA2
)
simData$weight <- rbind(weight1, weight2)
# * Maturity ----
MatAA <- as.data.frame(matrix(MatAA, ncol = 15))
colnames(MatAA) <- paste0("Age",1:15)
maturity1 <- cbind(data.frame(Species = 1),
MatAA
)
MatAA2 <- as.data.frame(matrix(MatAA2, ncol = 15))
colnames(MatAA2) <- paste0("Age",1:15)
maturity2 <- cbind(data.frame(Species = 2),
MatAA2
)
simData$maturity <- rbind(maturity1, maturity2)
# * Sex ratio ----
sexratio <- as.data.frame(matrix(0.5, ncol = 15))
colnames(sexratio) <- paste0("Age",1:15)
simData$sex_ratio <- cbind(data.frame(Species = 1),
sexratio
)
simData$sex_ratio <- rbind(simData$sex_ratio,
cbind(data.frame(Species = 2),
sexratio
)
)
# * Mortality ----
mort <- as.data.frame(matrix(0.2, ncol = 15))
colnames(mort) <- paste0("Age",1:15)
M1_base <- cbind(data.frame(Species = 1,
Sex = 0),
mort
)
mort <- as.data.frame(matrix(0.3, ncol = 15))
colnames(mort) <- paste0("Age",1:15)
M1_base2 <- cbind(data.frame(Species = 2,
Sex = 0),
mort
)
simData$M1_base <- rbind(M1_base, M1_base2)
# * Environmental data ----
simData$env_data <- data.frame(Year = 1:nyrs,
EnvData = 1)
# * Ration ----
Pyrs1 <- WAA * 50
colnames(Pyrs1) <- paste0("Age",1:15)
Pyrs1 <- cbind(data.frame(Species = 1,
Sex = 0,
Year = 0),
Pyrs1
)
Pyrs2 <- WAA2 * 50
colnames(Pyrs2) <- paste0("Age",1:15)
Pyrs2 <- cbind(data.frame(Species = 2,
Sex = 0,
Year = 0),
Pyrs2
)
simData$Pyrs <- rbind(Pyrs1, Pyrs2)
simData$Ceq <- rep(4,nspp)
simData$Cindex <- rep(1, nspp)
simData$Pvalue <- rep(1, nspp)
simData$fday <- rep(1, nspp)
simData$CA <- rep(1, nspp)
simData$CB <- rep(-1, nspp)
simData$Qc <- rep(1,nspp)
simData$Tco <- rep(1, nspp)
simData$Tcm <- rep(1, nspp)
simData$Tcl <- rep(1, nspp)
simData$CK1 <- rep(1, nspp)
simData$CK4 <- rep(1, nspp)
simData$Diet_comp_weights <- rep(1,nspp)
sim$diet_prop[2,2,1:5, 1:5, 1]
# 3) Fit single-species -------------------------------------------------------------
ss_run <- Rceattle::fit_mod(data_list = simData,
inits = NULL, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
msmMode = 0, # Single species mode
phase = TRUE,
initMode = 2,
verbose = 1)
ss_run$quantities$ration[2,1,,]
plot(x = sim$SSB[1,], y = ss_run$quantities$ssb[1,1:nyrs]); abline(1,1)
plot(x = sim$SSB[2,], y = ss_run$quantities$ssb[2,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[1,], y = ss_run$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ss_run$quantities$biomass[2,1:nyrs]); abline(1,1)
plot(x = sim$NAA[1,1,], y = ss_run$quantities$R[1,1:nyrs]); abline(1,1)
plot(x = sim$NAA[2,1,], y = ss_run$quantities$R[2,1:nyrs]); abline(1,1) ## This fit looks off
# * Fix suitability -----
# Fit multi-species -------------------------------------------------------------
# Function to organize data based on test case
##################################################################
## Test Case: Disaggregated Diet Data (estimateMode = 3 - debugg)
##################################################################
# Get all non-zero diet proportions
idx <- which(sim$diet_prop > 0, arr.ind = TRUE)
# Build the data frame directly
simData$diet_data <- data.frame(
Year = idx[, 5],
Pred = idx[, 1],
Prey = idx[, 2],
Pred_sex = 0,
Prey_sex = 0,
Pred_age = idx[, 3],
Prey_age = idx[, 4],
Sample_size = 1000,
Stomach_proportion_by_weight = sim$diet_prop[idx]
)
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
inits <- ss_run$estimated_params
inits$log_gam_a <- log(gam_a)
inits$log_gam_b <- log(gam_b)
inits$log_phi <- log_phi
inits$sel_inf[1,,1] <- c(3,6,2.5,4)
inits$ln_sel_slp[1,,1] <- log(c(2,2.5,2,2.5))
inits$ln_F[2,] <- log(Fmort)
inits$ln_F[4,] <- log(Fmort2)
inits$rec_pars[,1] <- log(c(1e2, 1e3))
inits$index_ln_q[] <- log(1)
inits$R_ln_sd[] <- log(1)
inits$rec_dev[,1:30] <- sim$rec_devs
inits$init_dev[,1:14] <- sim$init_devs
ms_run1 <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 3, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
suitMode = 4,
niter = 5,
initMode = 2,
verbose = 1)
plot(x = sim$NAA[1,1,], y = ms_run1$quantities$R[1,1:nyrs]); abline(1,1)
plot(x = sim$NAA[2,1,], y = ms_run1$quantities$R[2,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[1,], y = ms_run1$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run1$quantities$biomass[2,1:nyrs]); abline(1,1)
# Suitability is OK
exp(ms_run1$estimated_params$log_gam_a)-gam_a
exp(ms_run1$estimated_params$log_gam_b)-gam_b
sum(ms_run1$quantities$suitability[,,,,1] - sim$suitability)
ms_run1$quantities$vulnerability-sim$vulnerability
sim$suit_other -  ms_run1$quantities$vulnerability_other
# M2
sum(sim$M2_at_age - ms_run1$quantities$M2_at_age[,1,,1:nyrs])
# Ration
ms_run1$quantities$ration[,1,,1] - sim$ration
# AvgN
sum(ms_run1$quantities$avgN_at_age[,1,,1:nyrs] -sim$avgNAA[,,])
# Avail food
ms_run1$quantities$avail_food[,1,,1]-sim$avail_food[,,1]
# Selectivity
ms_run1$quantities$sel[c(1,3),,,1]-sim$srv_sel
ms_run1$quantities$sel[c(2,4),,,1]-sim$fish_sel
# F
sum(ms_run1$quantities$F_flt_age[c(2,4),1,,1:nyrs] - sim$FAA)
# Q
ms_run1$quantities$index_q
sim$srv_q
#plot_diet_comp(ms_run1)
ms_run1$quantities$suitability[2,1,1:5 ,1:5 ,1]
ms_run1$quantities$suit_other[2,1,1:5 ,1]
ms_run1$quantities$avail_food[2,1,1:5 ,1]
ms_run1$quantities$vulnerability
ms_run1$quantities$vulnerability_other
ms_run1$data_list$other_food
ms_run1$quantities$diet_prop_hat[1,1,1:5, 1:5, 1]
ms_run1$quantities$diet_prop_hat[1,2,1:5, 1:5, 1]
# Get all combinations of indices
idx <- which(sim$diet_prop > 0, arr.ind = TRUE)
# Build the data frame directly
simData$diet_data <- data.frame(
Year = idx[, 5],
Pred = idx[, 1],
Prey = idx[, 2],
Pred_sex = 0,
Prey_sex = 0,
Pred_age = idx[, 3],
Prey_age = idx[, 4],
Sample_size = 100,
Stomach_proportion_by_weight = sim$diet_prop[idx]
)
simData$diet_data <- simData$diet_data %>%
filter(!is.na(Pred))
ss_run$estimated_params$log_gam_a <- log(gam_a)
ss_run$estimated_params$log_gam_b <- log(gam_b)
ss_run$estimated_params$log_phi <- log_phi
ms_run1 <- Rceattle::fit_mod(data_list = simData,
inits = inits, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
suitMode = 4,
niter = 5,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run1$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run1$quantities$biomass[2,1:nyrs]); abline(1,1)
exp(ms_run1$estimated_params$log_gam_a)
gam_a
exp(ms_run1$estimated_params$log_gam_b)
gam_b
ms_run1$quantities$vulnerability
sim$vulnerability
# 4. Plot diet results
plot(
x = ms_run1$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run1$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Diet Data"
)
abline(0, 1)
ms_run1 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
suitMode = 4,
niter = 5,
initMode = 2,
verbose = 1)
# Plot model output
plot(x = sim$Total_Biom[1,], y = ms_run1$quantities$biomass[1,1:nyrs]); abline(1,1)
plot(x = sim$Total_Biom[2,], y = ms_run1$quantities$biomass[2,1:nyrs]); abline(1,1)
exp(ms_run1$estimated_params$log_gam_a)
gam_a
exp(ms_run1$estimated_params$log_gam_b)
gam_b
ms_run1$quantities$vulnerability
sim$vulnerability
# Plot diet results
plot(
x = ms_run1$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run1$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Diet Data"
)
abline(0, 1)
avg_over_years <- apply(sim$diet_prop, c(1, 2, 3, 4), mean)
diet_summary <- avg_over_years %>%
as.data.frame.table(responseName = "Stomach_proportion_by_weight") %>%
rename(
Pred = Var1,     Prey = Var2,
Pred_age = Var3, Prey_age = Var4
) %>%
mutate_at(vars(Pred, Prey, Pred_age, Prey_age), as.numeric)
simData$diet_data <- diet_summary %>%
filter(Stomach_proportion_by_weight > 0) %>%
mutate(
Year = 0,       # Set Year to 0 for year-aggregation
Pred_sex = 0,   # 0 for combined/non-sex-specific
Prey_sex = 0,
Sample_size = 200
)
# 2. Fit the model
# NOTE: The add_stomach_ids() call is removed.
ms_run2 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
# Check biomass fit (unchanged)
plot(x = sim$Total_Biom[1,], y = ms_run2$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run2$quantities$biomass[2,1:nyrs]); abline(0,1)
# Plot diet results
plot(
x = ms_run2$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run2$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Year-Aggregated Diet Data"
)
abline(0, 1)
# 1. Sum the 5D diet array across the 4th dimension (prey_age) using apply()
sum_over_prey_age <- apply(sim$diet_prop, c(1, 2, 3, 5), sum)
# 2. Convert the resulting 4D array to a long data frame
diet_summary <- sum_over_prey_age %>%
as.data.frame.table(responseName = "Stomach_proportion_by_weight") %>%
rename(
Pred = Var1,
Prey = Var2,
Pred_age = Var3,
Year = Var4
) %>%
# Convert factor columns back to numeric
mutate_at(vars(Pred, Prey, Pred_age, Year), as.numeric)
# 3. Format the data for Rceattle and remove rows with zero proportion
simData$diet_data <- diet_summary %>%
filter(Stomach_proportion_by_weight > 0) %>%
mutate(
Prey_age = -500,  # Set Prey_age to negative to trigger aggregation
Pred_sex = 0,   # 0 for combined/non-sex-specific
Prey_sex = 0,
Sample_size = 200
)
# 5. Now you can fit the model with this prey-age aggregated diet data
ms_run3 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run3$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run3$quantities$biomass[2,1:nyrs]); abline(0,1)
# Plot diet results
plot(
x = ms_run3$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run3$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Aggregated Diet Data"
)
abline(0, 1)
# 1. First, sum the 5D diet array across the 4th dimension (prey_age) for each year
sum_by_prey_age <- apply(sim$diet_prop, c(1, 2, 3, 5), sum)
# 2. Now, average the result of step 1 across its 4th dimension (which is years)
avg_of_annual_sums <- apply(sum_by_prey_age, c(1, 2, 3), mean)
# 3. Convert the resulting 3D array to a long data frame
diet_summary <- avg_of_annual_sums %>%
as.data.frame.table(responseName = "Stomach_proportion_by_weight") %>%
rename(
Pred = Var1,
Prey = Var2,
Pred_age = Var3
) %>%
# Convert factor columns back to numeric
mutate_at(vars(Pred, Prey, Pred_age), as.numeric)
# 4. Format the data for Rceattle and remove rows with zero proportion
simData$diet_data <- diet_summary %>%
filter(Stomach_proportion_by_weight > 0) %>%
mutate(
Year = 0,       # Set Year to 0 for year aggregation
Prey_age = -1,  # Set Prey_age to negative for prey-age aggregation
Pred_sex = 0,   # 0 for combined/non-sex-specific
Prey_sex = 0,
Sample_size = 200
)
# 6. Now you can fit the model
ms_run4 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run4$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run4$quantities$biomass[2,1:nyrs]); abline(0,1)
# Plot diet results
plot(
x = ms_run4$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run4$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Prey-summed Average Diet Data"
)
abline(0, 1)
# 1. First, sum the 5D diet array across prey ages (dimension 4)
sum_over_prey_age <- apply(sim$diet_prop, c(1, 2, 3, 5), sum)
# 2. Now, calculate the weighted average across predator ages (dimension 3)
#    FIX: Manually broadcast the predator numbers to match the diet array dimensions
pred_nums_broadcast <- array(sim$avgNAA, dim = dim(sum_over_prey_age))
#    Numerator: Sum of (Proportion * Predator Numbers) across predator ages
numerator <- apply(sum_over_prey_age * pred_nums_broadcast, c(1, 2, 4), sum)
#    Denominator: Sum of Predator Numbers across predator ages
denominator <- apply(sim$avgNAA, c(1, 3), sum)
#    Final weighted average proportion
pred_age_agg_prop <- numerator / array(denominator, dim = dim(numerator))
# 3. Convert the resulting 3D array [pred_spp, prey_spp, year] to a long data frame
diet_summary <- pred_age_agg_prop %>%
as.data.frame.table(responseName = "Stomach_proportion_by_weight") %>%
rename(
Pred = Var1,
Prey = Var2,
Year = Var3
) %>%
mutate_at(vars(Pred, Prey, Year), as.numeric)
# 4. Format the data for Rceattle
simData$diet_data <- diet_summary %>%
filter(Stomach_proportion_by_weight > 0) %>%
mutate(
Pred_age = -1, # Set Pred_age to negative
Prey_age = -1, # Set Prey_age to negative
Pred_sex = 0,
Prey_sex = 0,
Sample_size = 200
)
ms_run5 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run5$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run5$quantities$biomass[2,1:nyrs]); abline(0,1)
# Plot diet results
plot(
x = ms_run5$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run5$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Prey-summed Predator Averge Annual Diet Data"
)
abline(0, 1)
# 1. Perform the two-step aggregation to get year-specific values first
#    Step A: Sum across prey ages (dimension 4)
sum_over_prey_age <- apply(sim$diet_prop, c(1, 2, 3, 5), sum)
#    Step B: Calculate the weighted average across predator ages (dimension 3)
#    Broadcast the predator numbers to match the diet array dimensions
pred_nums_broadcast <- array(sim$avgNAA, dim = dim(sum_over_prey_age))
#    Calculate the numerator and denominator
numerator <- apply(sum_over_prey_age * pred_nums_broadcast, c(1, 2, 4), sum)
denominator <- apply(sim$avgNAA, c(1, 3), sum)
#    Get the year-specific aggregated proportions
pred_age_agg_prop <- numerator / array(denominator, dim = dim(numerator))
# 2. Add the final aggregation step
#    Step C: Average the result across years (the 3rd dimension)
all_agg_prop <- apply(pred_age_agg_prop, c(1, 2), mean)
# 3. Convert the resulting 2D matrix [pred_spp, prey_spp] to a long data frame
diet_summary <- all_agg_prop %>%
as.data.frame.table(responseName = "Stomach_proportion_by_weight") %>%
rename(
Pred = Var1,
Prey = Var2
) %>%
mutate_at(vars(Pred, Prey), as.numeric)
# 4. Format the data for Rceattle
simData$diet_data <- diet_summary %>%
filter(Stomach_proportion_by_weight > 0) %>%
mutate(
Year = 0,     # Set Year to 0
Pred_age = -1, # Set Pred_age to negative
Prey_age = -1, # Set Prey_age to negative
Pred_sex = 0,
Prey_sex = 0,
Sample_size = 200
)
ms_run6 <- Rceattle::fit_mod(data_list = simData,
inits = ss_run$estimated_params, # Initial parameters = 0
file = NULL, # Don't save
estimateMode = 0, # Estimate
random_rec = FALSE, # No random recruitment
phase = FALSE,
msmMode = 1,
niter = 5,
suitMode = 4,
initMode = 2,
verbose = 1)
plot(x = sim$Total_Biom[1,], y = ms_run6$quantities$biomass[1,1:nyrs]); abline(0,1)
plot(x = sim$Total_Biom[2,], y = ms_run6$quantities$biomass[2,1:nyrs]); abline(0,1)
# Plot diet results
plot(
x = ms_run6$data_list$diet_data$Stomach_proportion_by_weight,
y = ms_run6$quantities$diet_hat[,2],
xlab = "True Diet Proportion (Simulated)",
ylab = "Est Diet Proportion (Modeled)",
main = "Fit for Prey-summed Predator Average Diet Data"
)
abline(0, 1)
################################
##plot single species models
mod_list <- list(ss_run, ms_run1, ms_run2, ms_run3, ms_run4, ms_run5, ms_run6)
mod_names <- c("ss_run", "ms_run1", "ms_run2", "ms_run3", "ms_run4", "ms_run5", "ms_run6")
# Plot biomass trajectory
plot_biomass(Rceattle = mod_list, model_names = mod_names) #Now biomass looks alike
plot_biomass(Rceattle = mod_list, model_names = mod_names, add_ci = TRUE)
plot_depletionSSB(Rceattle = mod_list, model_names = mod_names) #this looks pretty different
plot_ssb(Rceattle = mod_list, model_names = mod_names, add_ci = TRUE)
plot_b_eaten_prop(Rceattle = mod_list, model_names = mod_names)
ms_run2$estimated_params$diet_comp_weights #1,1
ms_run2$data_list$Diet_weights_mcallister
