---
title: "Rceattle documentation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Rceattle documentation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
# Population dynamics

# Selectivity parameterizations
Multiple age-based selectivity functions are supported by Rceattle. They are controlled by `Selectivity_index`, `Selectivity`, `Nselages`, `Time_varying_sel`, `Sel_sd_prior`, and `Age_first_selected` in fleet_control sheet of an Rceattle data file. They are defined as follows:

* `Selectivity_index`:	index to use if selectivities of different surveys are to be the same
* `Selectivity`:	Selectivity parameterization to use for the species: 0 = empirical selectivity provided in `srv_emp_sel`; 1 = logistic selectivity; 2 = non-parametric selecitivty sensu Ianelli et al 2018; 3 = double logistic; 4 = descending logistic; 5 = non-parametric selectivity sensu Taylor et al 2014 (Hake)
* `Nselages`:	Number of ages to estimate non-parametric selectivity for Selectivity = 2 & 5. For example, if `minage = 1` and selectivity parameters are estimated up till age-6, `Nselages = 6` and if `minage = 0` and selectivity parameters are estimated up till age-6, `Nselages = 7`.  Not used otherwise
* `Time_varying_sel`:	Whether a time-varying selectivity should be estimated for logistic, double logistic selectivity, descending logistic, or non-parametric selectivity (`Selectivity = 5`). 0 = no, 1 = penalized deviates given sel_sd_prior, 2 = penalized deviates and estimate sel_sd_prior, 3 = time blocks with no penalty, 4 = random walk following Dorn, 5 = random walk on ascending portion of double logistic only. If selectivity is set to type = 2 (non-parametric) this value will be the 1st penalty on selectivity.
* `Sel_sd_prior`:	The sd to use for the random walk of time varying selectivity if set to 1. If selectivity is set to type = 2 (non-parametric) this value will be the 2nd penalty on selectivity.
* `Age_first_selected`:	Age at which selectivity is non-zero. Selectivity before this age will be set to 0.

## Non-parametric (Type 1)
Input:
`Selectivity = 2`, `Nselages = 6`, `Time_varying_sel = 12.5`, `Sel_sd_prior = 200`, and `Age_first_selected = 1`

Equation:
$$sel_{f_i sa}=e^{\phi_{f_isa}}$$

## Logistic
Input:
`Selectivity = 1`, `Nselages = NA`, `Time_varying_sel = 0`, and `Sel_sd_prior = NA`

Equation:
$$sel_{f_i sa}=1/(1+e^{-Slp_{f_i} (a-Inf_{f_i} ) } )$$

## Time-varying logistic
Input:
`Selectivity = 1`, `Nselages = NA`, and `Sel_sd_prior = 0.1` or other desired value. 

Equation:
$$sel_{f_i sa}=1/(1+e^{-(Slp_{f_i}+e^{\phi_{f_i sy}^{slp} } ) (a-(Inf_{f_i}+\phi_{f_i sy}^{Inf} ) ) } )$$
Penalized likelihood: `Time_varying_sel = 1`
$$\phi_{f_i sy} \sim N(0,\sigma^{\phi}_{f_i}) $$
Random effect: `Time_varying_sel = 2` $\hat\sigma^{\phi}_{f_i}$ is estimated
$$\phi_{f_i sy} \sim N(0,\hat\sigma^{\phi}_{f_i}) $$
Block: `Time_varying_sel = 3` main parameters are set to 0 and the following is specificed:
$$\phi_{f_i sy} = \phi_{f_i sy_{block}}$$
Penalized likelihood random walk `Time_varying_sel = 4`
$$\phi_{f_i sy}-\phi_{f_i sy-1} \sim N(0,\sigma^{\phi}_{f_i}) $$

## Double logistic
Input:
`Selectivity = 3`, `Nselages = NA`, `Time_varying_sel = 0`, and `Sel_sd_prior = NA`

Equation:
$$sel_{f_i sa}=1/(1+e^{-Slp1_{f_i} (a-Inf1_{f_i} ) } )(1-1/(1+e^{-Slp2_{f_i} (a-Inf2_{f_i} ) } ))$$

## Time-varying double logistic 1	(ascending and descending time-varying parameters)
$$sel_{f_i sa}=1/(1+e^{-(Slp1_{f_i}+e^{\phi_{f_i sy}^{slp1} } ) (a-(Inf1_{f_i}+\phi_{f_i sy}^{Inf1} ) ) } )(1-1/(1+e^{-(Slp2_{f_i}+e^{\phi_{f_i sy}^{slp2} } ) (a-(Inf2_{f_i}+\phi_{f_i sy}^{Inf2} ) ) } ))$$

Penalized likelihood: `Time_varying_sel = 1`
$$\phi_{f_i sy} \sim N(0,\sigma^{\phi}_{f_i}) $$
Random effect: `Time_varying_sel = 2` $\hat\sigma^{\phi}_{f_i}$ is estimated
$$\phi_{f_i sy} \sim N(0,\hat\sigma^{\phi}_{f_i}) $$
Block: `Time_varying_sel = 3` main parameters are set to 0 and the following is specificed:
$$\phi_{f_i sy} = \phi_{f_i sy_{block}}$$
Penalized likelihood random walk `Time_varying_sel = 4`
$$\phi_{f_i sy}-\phi_{f_i sy-1} \sim N(0,\sigma^{\phi}_{f_i}) $$

## Time-varying double logistic 2	(random walk ascending-time varying parameters)
Input:
`Selectivity = 3`, `Nselages = NA`, `Time_varying_sel = 5`, and `Sel_sd_prior = NA`

Equation:
$$sel_{f_i sa}=1/(1+e^{-(Slp1_{f_i}+e^{\phi_{f_i sy}^{slp1} } ) (a-(Inf1_{f_i}+\phi_{f_i sy}^{Inf1} ) ) } )(1-1/(1+e^{-Slp2_{f_i} (a-Inf2_{f_i} ) } ))$$

$$\phi_{f_i sy} - \phi_{f_i sy-1} \sim N(0,\sigma^{\phi}_{f_i}) $$

## Descending logistic
Input:
`Selectivity = 4`, `Nselages = NA`, `Time_varying_sel = 0`, and `Sel_sd_prior = NA`

Equation:
$$sel_{f_i sa}=1-1/(1+e^{-Slp2_{f_i} (a-Inf2_{f_i} ) } )$$

## Time-varying descending logistic	
Input:
`Selectivity = 4`, `Nselages = NA`, `Time_varying_sel = 1` or `2` , and `Sel_sd_prior = NA`

Equation:
$$sel_{f_i sa}=1-1/(1+e^{-(Slp2_{f_i}+e^{\phi_{f_i sy}^{slp2} } ) (a-(Inf2_{f_i}+\phi_{f_i sy}^{Inf2} ) ) } )$$

Penalized likelihood: `Time_varying_sel = 1`
$$\phi_{f_i sy} \sim N(0,\sigma^{\phi}_{f_i}) $$
Random effect: `Time_varying_sel = 2` $\hat\sigma^{\phi}_{f_i}$ is estimated
$$\phi_{f_i sy} \sim N(0,\hat\sigma^{\phi}_{f_i}) $$
Block: `Time_varying_sel = 3` main parameters are set to 0 and the following is specificed:
$$\phi_{f_i sy} = \phi_{f_i sy_{block}}$$
Penalized likelihood random walk `Time_varying_sel = 4`
$$\phi_{f_i sy}-\phi_{f_i sy-1} \sim N(0,\sigma^{\phi}_{f_i}) $$

## Non-parametric (Type 2)
For each age $a \geq A_{min}$ there is an incremental selectivity parameter $p_{f_i say}$ for the fleet $f_i$. Selectivity at age is calculated as follows:

$$sel_{f_i sa}=e^{sel^{`}_{f_i sa} - max(sel^{`}_{f_i sa})}$$
where
$$ sel^{`}_{f_i sa} = \sum_{i=A_{min}}^a p_{f_i sa}$$
Selectivity is fixed at $sel_{f_i sa} = 0$ for $a < A_{min}$ and $p_{f_i sa} = 0$ for ages above `minage + Nselages`, giving constant selectivity beyond the last estimated value. `minage` is specified in the data and is the minimum age of the modeled population.

Input:
`Selectivity = 5`, `Nselages = 6`, `Time_varying_sel = NA`,  `Sel_sd_prior = NA`, and `Age_first_selected = `$A_{min}$

## Time-varying non-parametric (Type 2)
As above, but a set of deviations on $p_a$ is used  to control annual changes in selectivity given a fixed or estimated standard deviation ($\sigma^{\phi}_{f_i}$):
$$p_{f_i say}=p_{f_i sa}+\phi_{f_i say}$$

Input:
`Selectivity = 5`, `Nselages = 6`, `Time_varying_sel = NA`,  `Sel_sd_prior = NA`, and `Age_first_selected = `$A_{min}$

Penalized likelihood: `Time_varying_sel = 1`
$$\phi_{f_i sy} \sim N(0,\sigma^{\phi}_{f_i}) $$
Random effect: `Time_varying_sel = 2` $\hat\sigma^{\phi}_{f_i}$ is estimated
$$\phi_{f_i sy} \sim N(0,\hat\sigma^{\phi}_{f_i}) $$


# Catchability parameterizations

